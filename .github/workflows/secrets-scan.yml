name: Secrets Scan

on:
  push:
    branches: [ "master", "main" ]
  pull_request:
    branches: [ "master", "main" ]
  workflow_dispatch:

jobs:
  gitleaks:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Run Gitleaks
        uses: gitleaks/gitleaks-action@v2
        with:
          args: detect --source=. --report-format=json --report-path=gitleaks-report.json

      - name: Convert Gitleaks JSON to CSV
        run: |
          python - << 'EOF'
          import json
          import csv
          from pathlib import Path

          report_path = Path("gitleaks-report.json")
          if not report_path.exists():
              print("Gitleaks JSON report not found at", report_path)
              raise SystemExit(0)

          data = json.load(report_path.open(encoding="utf-8"))

          # Ожидаемый формат: {"results": [ {...}, {...} ]}
          results = data.get("results") or []

          fieldnames = [
              "description",
              "rule_id",
              "file",
              "line",
              "offender",
              "secret",
              "commit",
              "author",
              "email",
              "date",
              "tags",
          ]

          csv_path = Path("gitleaks-report.csv")
          with csv_path.open("w", newline="", encoding="utf-8") as csvfile:
              writer = csv.DictWriter(csvfile, fieldnames=fieldnames)
              writer.writeheader()
              for r in results:
                  writer.writerow({
                      "description": r.get("description"),
                      "rule_id": r.get("ruleID"),
                      "file": r.get("file"),
                      "line": r.get("line"),
                      "offender": r.get("offender"),
                      "secret": r.get("secret"),
                      "commit": r.get("commit"),
                      "author": r.get("author"),
                      "email": r.get("email"),
                      "date": r.get("date"),
                      "tags": ",".join(r.get("tags") or []),
                  })
          EOF

      - name: Upload Gitleaks reports
        uses: actions/upload-artifact@v4
        with:
          name: gitleaks-report
          path: |
            gitleaks-report.json
            gitleaks-report.csv
