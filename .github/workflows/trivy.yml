name: Image and FS Scan

on:
  push:
    branches: [ "master", "main" ]
  workflow_dispatch:

jobs:
  trivy-fs-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run Trivy FS scan (JSON)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          scan-type: 'fs'
          ignore-unfixed: true
          format: 'json'
          output: 'trivy-fs-report.json'
          severity: 'HIGH,CRITICAL'

      - name: Convert Trivy FS JSON to CSV
        run: |
          python - << 'EOF'
          import json
          import csv
          from pathlib import Path

          report_path = Path("trivy-fs-report.json")
          if not report_path.exists():
              print("Trivy FS JSON report not found at", report_path)
              raise SystemExit(0)

          data = json.load(report_path.open(encoding="utf-8"))

          # Trivy JSON: { "Results": [ { "Target": "...", "Vulnerabilities": [ ... ] }, ... ] }
          results = data.get("Results") or []

          fieldnames = [
              "target",
              "vulnerability_id",
              "pkg_name",
              "installed_version",
              "fixed_version",
              "severity",
              "title",
              "description",
              "references",
          ]

          csv_path = Path("trivy-fs-report.csv")
          with csv_path.open("w", newline="", encoding="utf-8") as csvfile:
              writer = csv.DictWriter(csvfile, fieldnames=fieldnames)
              writer.writeheader()

              for res in results:
                  target = res.get("Target")
                  vulns = res.get("Vulnerabilities") or []
                  for v in vulns:
                      writer.writerow({
                          "target": target,
                          "vulnerability_id": v.get("VulnerabilityID"),
                          "pkg_name": v.get("PkgName"),
                          "installed_version": v.get("InstalledVersion"),
                          "fixed_version": v.get("FixedVersion"),
                          "severity": v.get("Severity"),
                          "title": v.get("Title"),
                          "description": v.get("Description"),
                          "references": " ".join(v.get("References") or []),
                      })
          EOF

      - name: Upload Trivy FS reports
        uses: actions/upload-artifact@v4
        with:
          name: trivy-fs-report
          path: |
            trivy-fs-report.json
            trivy-fs-report.csv

  trivy-image-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Pull Django image
        run: |
          docker pull ghcr.io/${{ github.repository_owner }}/defectdojo-django:latest

      - name: Pull Nginx image
        run: |
          docker pull ghcr.io/${{ github.repository_owner }}/defectdojo-nginx:latest

      - name: Scan Django image with Trivy (JSON)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ghcr.io/${{ github.repository_owner }}/defectdojo-django:latest
          format: 'json'
          output: 'trivy-django-image-report.json'
          severity: 'HIGH,CRITICAL'

      - name: Scan Nginx image with Trivy (JSON)
        uses: aquasecurity/trivy-action@0.28.0
        with:
          image-ref: ghcr.io/${{ github.repository_owner }}/defectdojo-nginx:latest
          format: 'json'
          output: 'trivy-nginx-image-report.json'
          severity: 'HIGH,CRITICAL'

      - name: Convert Trivy JSON to CSV
        run: |
          python - << 'EOF'
          import json, csv
          from pathlib import Path

          def convert(json_name, csv_name):
              p = Path(json_name)
              if not p.exists():
                  print("No JSON report:", json_name)
                  return
              data = json.load(p.open(encoding="utf-8"))
              results = data.get("Results") or []
              fieldnames = [
                  "target",
                  "vulnerability_id",
                  "pkg_name",
                  "installed_version",
                  "fixed_version",
                  "severity",
                  "title",
                  "description",
                  "references",
              ]
              with Path(csv_name).open("w", newline="", encoding="utf-8") as f:
                  w = csv.DictWriter(f, fieldnames=fieldnames)
                  w.writeheader()
                  for res in results:
                      target = res.get("Target")
                      for v in res.get("Vulnerabilities") or []:
                          w.writerow({
                              "target": target,
                              "vulnerability_id": v.get("VulnerabilityID"),
                              "pkg_name": v.get("PkgName"),
                              "installed_version": v.get("InstalledVersion"),
                              "fixed_version": v.get("FixedVersion"),
                              "severity": v.get("Severity"),
                              "title": v.get("Title"),
                              "description": v.get("Description"),
                              "references": " ".join(v.get("References") or []),
                          })

          convert("trivy-django-image-report.json", "trivy-django-image-report.csv")
          convert("trivy-nginx-image-report.json", "trivy-nginx-image-report.csv")
          EOF

      - name: Upload Trivy image reports
        uses: actions/upload-artifact@v4
        with:
          name: trivy-image-reports
          path: |
            trivy-django-image-report.json
            trivy-django-image-report.csv
            trivy-nginx-image-report.json
            trivy-nginx-image-report.csv
